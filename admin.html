<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>COOLZM — Админ-панель жалоб</title>
  <meta name="color-scheme" content="dark light"/>
  <style>
    /* ======= ТЕМА как на сайте ======= */
    :root{
      --bg:#0b0f14; --card:#101722; --text:#e5f1ff; --muted:#9ab0c9;
      --primary:#00ff7f; --accent:#00c2ff; --border:#1d2a3a;
      --shadow:0 12px 30px rgba(0,0,0,.35); --radius:16px; --ring:0 0 0 3px rgba(0,255,127,.25)
    }
    [data-theme="light"]{
      --bg:#f7fafc; --card:#fff; --text:#0e1a2a; --muted:#5b6b7f; --primary:#0ea5e9; --accent:#16a34a; --border:#e5eaf0;
      --shadow:0 10px 24px rgba(2,6,23,.08); --ring:0 0 0 3px rgba(14,165,233,.22)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 900px at 10% -10%,rgba(0,194,255,.08),transparent 60%),
        radial-gradient(1000px 700px at 110% -20%,rgba(0,255,127,.08),transparent 60%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,"Noto Sans","Segoe UI Emoji";
      line-height:1.6;
    }
    a{color:var(--primary);text-decoration:none}
    a:hover{text-decoration:underline}

    header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid var(--border);background:rgba(6,10,16,.6)}
    [data-theme="light"] header{background:rgba(255,255,255,.7)}
    .nav{max-width:1100px;margin:0 auto;padding:12px 16px;display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center}
    .brand{display:flex;align-items:center;gap:12px;font-weight:900}
    .logo{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(135deg,var(--primary),var(--accent));box-shadow:var(--shadow);color:#001b1b;font-weight:1000}
    .logo img{width:100%;border-radius:12px}
    .controls{display:flex;gap:8px;align-items:center}
    .btn, select, input[type="text"], input[type="password"]{
      height:40px;padding:0 12px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--text);
    }
    .btn{cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn.primary{background:var(--primary);color:#001b1b;border-color:transparent;font-weight:800}
    .btn:hover{filter:brightness(1.05)}
    .muted{color:var(--muted)}
    .tag{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:rgba(0,255,127,.08);border-radius:999px;padding:4px 8px;font-size:.85rem}

    main{max-width:1100px;margin:0 auto;padding:24px 16px 60px}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{grid-column:span 12;border:1px solid var(--border);border-radius:var(--radius);background:var(--card);padding:16px;box-shadow:var(--shadow)}

    .headline{font-size:clamp(26px,3.6vw,40px);font-weight:1000;margin:0 0 8px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .search{flex:1;min-width:220px}
    .search input{width:100%}

    .stats{display:flex;flex-wrap:wrap;gap:8px}
    .stat{display:flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--bg);border-radius:12px;padding:8px 12px}
    .stat b{font-size:1.1rem}

    .list{display:grid;gap:12px;margin-top:12px}
    .item{border:1px solid var(--border);border-radius:14px;padding:14px;background:linear-gradient(180deg,rgba(0,255,127,.04),transparent),var(--card)}
    .itemHead{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .itemMeta{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .itemBody{margin-top:8px;color:var(--muted)}
    .itemActions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    .badge{border:1px solid var(--border);border-radius:8px;padding:2px 8px;font-size:.85rem;background:rgba(0,194,255,.08)}
    .status-new{background:rgba(0,194,255,.12)}
    .status-opened{background:rgba(255,200,0,.12)}
    .status-resolved{background:rgba(0,255,127,.12)}
    .me{background:rgba(0,255,127,.16)}

    .empty{padding:28px;text-align:center;border:1px dashed var(--border);border-radius:14px;color:var(--muted)}

    /* Логин-оверлей */
    .gate{
      position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:50;
    }
    .gate .panel{
      width:min(520px,100%);background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:var(--shadow)
    }
    .gate .panel h3{margin:0 0 10px}
    .rows{display:grid;gap:10px}
    .hint{font-size:.9rem;color:var(--muted)}
    .err{color:#ff6b6b}

    @media (max-width:760px){
      .toolbar{flex-direction:column;align-items:stretch}
      .itemHead{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <header>
    <nav class="nav">
      <div class="brand">
        <div class="logo"><img src="./logo.png" alt=""></div>
        <div>
          <div style="font-weight:800">COOLZM</div>
          <div class="muted">Админ-панель жалоб</div>
        </div>
      </div>
      <div class="controls">
        <button id="theme" class="btn">Dark</button>
        <a href="./index.html" class="btn">← На сайт</a>
      </div>
      <div class="controls">
        <button id="logout" class="btn">Выйти</button>
        <span class="tag" id="who">Не авторизовано</span>  
    </div>
    </nav>
  </header>

  <main>
    <h1 class="headline">Жалобы</h1>

    <div class="toolbar card">
      <div class="stats">
        <div class="stat"><span>Все:</span> <b id="c_all">0</b></div>
        <div class="stat"><span>Новые:</span> <b id="c_new">0</b></div>
        <div class="stat"><span>В работе:</span> <b id="c_open">0</b></div>
        <div class="stat"><span>Завершено:</span> <b id="c_done">0</b></div>
      </div>
      <select id="flt">
        <option value="">Все статусы</option>
        <option value="new">Только новые</option>
        <option value="opened">Только в работе</option>
        <option value="resolved">Только завершённые</option>
      </select>
      <div class="search"><input id="q" placeholder="Поиск: ник, SteamID, причина, репортёр, админ…"></div>
    </div>

    <section class="list" id="list"></section>
    <div class="empty" id="empty" style="display:none">Пока нет записей</div>
  </main>

  <!-- === Оверлей входа === -->
  <div class="gate" id="gate">
    <div class="panel">
      <h3>Вход для админов</h3>
      <div class="rows">
        <input type="password" id="pass" placeholder="Пароль администратора" autocomplete="current-password">
        <input type="text" id="name" placeholder="Ваше имя (для пометки «взято мной»)" autocomplete="name">
        <div class="hint">Подсказка: одно имя — для метки «handledBy». Пароль хранится только в сессии.</div>
        <div class="err" id="err" style="display:none"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" id="cancel">Отмена</button>
          <button class="btn primary" id="ok">Войти</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  /* ================== THEME ================== */
  const $ = (q,c=document)=>c.querySelector(q);
  const $$ = (q,c=document)=>Array.from(c.querySelectorAll(q));
  const state = {
    theme: localStorage.getItem('theme') || 'dark'
  };
  function applyTheme(){
    document.documentElement.setAttribute('data-theme', state.theme);
    $('#theme').textContent = state.theme==='dark' ? 'Dark' : 'Light';
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    applyTheme();
    $('#theme').addEventListener('click',()=>{
      state.theme = state.theme==='dark' ? 'light' : 'dark';
      localStorage.setItem('theme', state.theme);
      applyTheme();
    });
  });

  /* ================== AUTH ================== */
  const ADMIN_PASS = '846534673739926856353474';
  function meName(){ return (sessionStorage.getItem('coolzm_admin_name') || '').trim(); }
  function setMe(name){
    sessionStorage.setItem('coolzm_admin_name', name.trim());
    sessionStorage.setItem('coolzm_admin_auth', '1');
    $('#who').textContent = 'Вы: ' + name.trim();
  }
  function isAuthed(){ return sessionStorage.getItem('coolzm_admin_auth') === '1'; }
  function requireAuth(){
    if(!isAuthed()){ openGate(); }
    else { $('#who').textContent = 'Вы: ' + meName(); }
  }
  function logout(){
    sessionStorage.removeItem('coolzm_admin_auth');
    // имя можно оставить, чтобы не вводить снова — но обнулим для честности:
    // sessionStorage.removeItem('coolzm_admin_name');
    location.reload();
  }

  const gate = $('#gate'), pass = $('#pass'), nameI = $('#name'), err = $('#err');
  function openGate(){ gate.style.display='flex'; setTimeout(()=>pass.focus(),0); }
  function closeGate(){ gate.style.display='none'; }
  $('#logout').addEventListener('click', logout);
  $('#ok').addEventListener('click', ()=>{
    err.style.display='none';
    const ok = pass.value === ADMIN_PASS;
    const nm = nameI.value.trim();
    if(!ok){ err.textContent = 'Неверный пароль'; err.style.display='block'; return; }
    if(!nm){ err.textContent = 'Введите имя админа'; err.style.display='block'; return; }
    setMe(nm);
    closeGate();
    render();
  });
  $('#cancel').addEventListener('click', ()=>{ history.back(); });
  // Enter submit
  [pass, nameI].forEach(inp=>inp.addEventListener('keyup',(e)=>{ if(e.key==='Enter') $('#ok').click(); }));

  /* ================== STORAGE (один объект в localStorage) ================== */
  const KEY = 'coolzm_reports_v1';
  const Reports = {
    _cache: null,
    _loadRaw(){
      try {
        const raw = JSON.parse(localStorage.getItem(KEY) || '[]');
        // Поддержка старого формата: просто массив
        if (Array.isArray(raw)) {
          const lastId = raw.reduce((m, r)=>Math.max(m, Number(r.id||0)), 0);
          return { version:1, lastId, items: raw };
        }
        // Нормальный объект
        if (raw && typeof raw === 'object') {
          if (!Array.isArray(raw.items)) raw.items = [];
          if (typeof raw.lastId !== 'number') raw.lastId = raw.items.reduce((m, r)=>Math.max(m, Number(r.id||0)), 0);
          if (!raw.version) raw.version = 1;
          return raw;
        }
        return { version:1, lastId:0, items:[] };
      } catch(e){
        return { version:1, lastId:0, items:[] };
      }
    },
    load(){
      this._cache = this._loadRaw();
      return this._cache;
    },
    save(data){
      localStorage.setItem(KEY, JSON.stringify(data));
      this._cache = data;
    },
    list(){
      const d = this._cache || this.load();
      // Нормализуем поля на лету
      return d.items.map(r => ({
        id: r.id ?? 0,
        createdAt: r.createdAt || new Date().toISOString(),
        player: r.player || '',
        steam: r.steam || '',
        reason: r.reason || '',
        evidence: r.evidence || '',
        reporter: r.reporter || '',
        status: r.status || 'new',
        handledBy: r.handledBy || ''
      })).sort((a,b)=> String(b.createdAt).localeCompare(String(a.createdAt)));
    },
    update(id, patch){
      const d = this._cache || this.load();
      const i = d.items.findIndex(x=>String(x.id)===String(id));
      if(i<0) return;
      d.items[i] = { ...d.items[i], ...patch };
      this.save(d);
    },
    assign(id, adminName){
      this.update(id, { status:'opened', handledBy: adminName });
    },
    returnToNew(id){
      this.update(id, { status:'new', handledBy: '' });
    },
    resolve(id){
      this.update(id, { status:'resolved' });
    },
    remove(id){
      const d = this._cache || this.load();
      const i = d.items.findIndex(x=>String(x.id)===String(id));
      if(i>=0){ d.items.splice(i,1); this.save(d); }
    }
  };

  /* ================== ВИДИМОСТЬ (скрыть чужие «в работе») ================== */
  function isVisibleToMe(r){
    const me = meName().toLowerCase();
    if (r.status === 'opened' && r.handledBy && r.handledBy.toLowerCase() !== me) {
      return false; // чужая «в работе» — скрыть
    }
    return true;
  }
  function getVisibleReports(){
    return Reports.list().filter(isVisibleToMe);
  }

  /* ================== РЕНДЕР ================== */
  const listEl = $('#list'), emptyEl = $('#empty');
  const q = $('#q'), flt = $('#flt');
  const c_all = $('#c_all'), c_new = $('#c_new'), c_open = $('#c_open'), c_done = $('#c_done');

  function counters(arr){
    c_all.textContent = arr.length;
    c_new.textContent = arr.filter(x=>x.status==='new').length;
    c_open.textContent = arr.filter(x=>x.status==='opened').length;
    c_done.textContent = arr.filter(x=>x.status==='resolved').length;
  }

  function fmtDate(iso){
    try {
      const d = new Date(iso);
      return d.toLocaleString();
    } catch { return iso || ''; }
  }

  function row(r){
    const me = meName();
    const mine = r.handledBy && r.handledBy.toLowerCase() === me.toLowerCase();
    const stClass = r.status==='new'?'status-new':(r.status==='opened'?'status-opened':'status-resolved');
    return `
      <article class="item" data-id="${r.id}">
        <div class="itemHead">
          <div class="itemMeta">
            <span class="badge ${stClass}">Статус: ${r.status}</span>
            ${r.handledBy ? `<span class="badge ${mine?'me':''}">Взял: ${r.handledBy}${mine?' (я)':''}</span>` : ''}
            <span class="badge">#${r.id}</span>
            <span class="muted">${fmtDate(r.createdAt)}</span>
          </div>
          <div class="itemMeta">
            ${r.player ? `<span class="badge">Игрок: ${escapeHtml(r.player)}</span>`:''}
            ${r.steam ? `<span class="badge">Steam: ${escapeHtml(r.steam)}</span>`:''}
          </div>
        </div>
        <div class="itemBody">
          <div><b>Причина:</b> ${escapeHtml(r.reason||'')}</div>
          ${r.evidence ? `<div><b>Доказательства:</b> ${linkify(escapeHtml(r.evidence))}</div>`:''}
          ${r.reporter ? `<div class="muted">Репортёр: ${escapeHtml(r.reporter)}</div>`:''}
        </div>
        <div class="itemActions">
          ${r.status==='new' ? `<button class="btn primary" data-act="take" data-id="${r.id}">Взять на себя</button>`:''}
          ${r.status==='opened' && mine ? `<button class="btn" data-act="return" data-id="${r.id}">Вернуть</button>`:''}
          ${r.status==='opened' && mine ? `<button class="btn primary" data-act="done" data-id="${r.id}">Завершить</button>`:''}
          ${r.status==='resolved' ? `<button class="btn" data-act="return" data-id="${r.id}">Вернуть</button>`:''}
          <button class="btn" data-act="copy" data-id="${r.id}">Скопировать</button>
        </div>
      </article>
    `;
  }

  function render(){
    if(!isAuthed()){ requireAuth(); return; }
    let arr = getVisibleReports();
    const Q = q.value.trim().toLowerCase();
    const F = flt.value;
    if (F) arr = arr.filter(r=> r.status === F);
    if (Q) arr = arr.filter(r=>{
      const s = (r.player+' '+r.steam+' '+r.reason+' '+(r.reporter||'')+' '+(r.handledBy||'')).toLowerCase();
      return s.includes(Q);
    });

    counters(arr);
    listEl.innerHTML = arr.map(row).join('');
    emptyEl.style.display = arr.length ? 'none':'block';
  }

  /* ================== ДЕЙСТВИЯ ================== */
  function onAction(e){
    const btn = e.target.closest('[data-act]');
    if(!btn) return;
    const act = btn.dataset.act;
    const id = btn.dataset.id;
    const me = meName();
    if (act==='take'){
      Reports.assign(id, me);
    } else if (act==='return'){
      Reports.returnToNew(id);
    } else if (act==='done'){
      Reports.resolve(id);
    } else if (act==='copy'){
      const item = Reports.list().find(x=>String(x.id)===String(id));
      if(item){
        const text =
`#${item.id} • ${fmtDate(item.createdAt)}
Игрок: ${item.player} | Steam: ${item.steam}
Причина: ${item.reason}
Доказательства: ${item.evidence}
Статус: ${item.status}${item.handledBy?` | Взял: ${item.handledBy}`:''}`;
        navigator.clipboard?.writeText(text);
        btn.classList.add('primary'); setTimeout(()=>btn.classList.remove('primary'), 400);
      }
    }
    render(); // у меня
    // для других вкладок сработает storage
  }

  listEl.addEventListener('click', onAction);
  q.addEventListener('input', render);
  flt.addEventListener('change', render);

  // Синхронизация между вкладками
  window.addEventListener('storage', (e)=>{
    if (e.key === KEY) {
      Reports.load(); // обновить кэш
      render();
    }
  });

  // Безопасные утилиты
  function escapeHtml(s){
    return String(s||'')
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#039;");
  }
  function linkify(text){
    // простая подстановка ссылок
    return text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
  }

  // INIT       
  document.addEventListener('DOMContentLoaded', ()=>{
    // показать «кто я» если авторизован
    if (isAuthed()) $('#who').textContent = 'Вы: ' + meName();
    Reports.load();
    render();
  });
  </script>
</body>
</html>
